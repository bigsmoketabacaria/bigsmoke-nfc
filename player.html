<script>
const firebaseConfig = {
  apiKey: "AIzaSyDSFd-aLgogUqsRAxne5avvAIiYF6cUFKE",
  authDomain: "bigsmoke-nfc.firebaseapp.com",
  projectId: "bigsmoke-nfc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const id = new URLSearchParams(window.location.search).get("id");

/* ğŸ”° RANK */
function calcularRank(respeito) {
  if (respeito >= 8000) return 5;
  if (respeito >= 6000) return 4;
  if (respeito >= 4000) return 3;
  if (respeito >= 2000) return 2;
  return 1;
}

function estrelas(qt) {
  return "â˜…".repeat(qt) + "â˜†".repeat(5 - qt);
}

/* ğŸ… CONQUISTAS */
const conquistasDisponiveis = [
  { id: "iniciante", nome: "Primeiro Contato", regra: p => p.respeito >= 100 },
  { id: "cliente_fiel", nome: "Cliente Fiel", regra: p => (p.compras || 0) >= 500 },
  { id: "elite", nome: "Elite Big Smoke", regra: p => p.rank >= 4 },
  { id: "vip", nome: "VIP Big Smoke", regra: p => p.rank === 5 }
];

/* ğŸ§ AVATAR */
function setAvatar(id) {
  const avatar = document.getElementById("avatar");
  const img = new Image();
  img.src = `avatars/${id}.png`;
  img.onload = () => avatar.style.backgroundImage = `url(${img.src})`;
  img.onerror = () => avatar.style.backgroundImage = `url(avatars/default.png)`;
}

/* ğŸ”” NOTIFICAÃ‡ÃƒO */
function notify(msg) {
  const n = document.createElement("div");
  n.innerText = msg;
  n.style.position = "fixed";
  n.style.bottom = "20px";
  n.style.left = "50%";
  n.style.transform = "translateX(-50%)";
  n.style.background = "#2ecc71";
  n.style.color = "#000";
  n.style.padding = "10px 18px";
  n.style.borderRadius = "10px";
  n.style.fontWeight = "700";
  n.style.zIndex = "999";
  document.body.appendChild(n);
  setTimeout(() => n.remove(), 3500);
}

/* ğŸš€ PLAYER LOAD */
if (id) {
  db.collection("players").doc(id).onSnapshot(doc => {
    if (!doc.exists) return;

    const p = doc.data();
    const respeito = p.respeito || 0;
    const rankAtual = calcularRank(respeito);
    const rankAnterior = p.ultimoRank || 1;

    document.getElementById("apelido").innerText = "@" + p.apelido;
    document.getElementById("stars").innerText = estrelas(rankAtual);

    const inicioRank = (rankAtual - 1) * 2000;
    const fimRank = rankAtual * 2000;
    const progresso = ((respeito - inicioRank) / (fimRank - inicioRank)) * 100;

    document.getElementById("xpBar").style.width =
      Math.max(0, Math.min(100, progresso)) + "%";

    document.getElementById("xpInfo").innerText =
      `Respeito: ${respeito} XP â€¢ Rank ${rankAtual}`;

    /* â­ RANK UP */
    if (rankAtual > rankAnterior) {
      notify(`â­ Novo Rank desbloqueado! (${rankAtual} estrelas)`);
      db.collection("players").doc(id).update({ ultimoRank: rankAtual });
    }

    /* ğŸ… CONQUISTAS */
    const conquistasAtuais = p.conquistas || [];
    conquistasDisponiveis.forEach(c => {
      if (!conquistasAtuais.includes(c.id) && c.regra({ ...p, rank: rankAtual })) {
        conquistasAtuais.push(c.id);
        notify(`ğŸ… Conquista desbloqueada: ${c.nome}`);
      }
    });

    db.collection("players").doc(id).update({
      rank: rankAtual,
      conquistas: conquistasAtuais
    });

    setAvatar(id);
  });
}
</script>
